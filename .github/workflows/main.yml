name: Auto Merge

on:
  push:
    branches:
      - revision

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Check parameter in index file
        env:
          REPO_ACCESS_TOKEN: ${{ secrets.TOKEN_ACCESSO_GENERICO_ADMIN }}
        run: |
          PARAM=$(grep "const versione = *.*.*" index.html || echo "false")
          echo "Parameter found: $PARAM"
          if [ -n "$PARAM" ]; then
            echo "Merging branch revision"
            git config --global user.name "MaZap75"
            git config --global user.email "mzappulla75@gmail.com"
            git remote set-url origin https://x-access-token:${REPO_ACCESS_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
            git fetch
            git checkout main
            echo "checkout main ok"
            git merge revision -X theirs --allow-unrelated-histories
            git push origin main
          else
            echo "Merge condition not met."
          fi
